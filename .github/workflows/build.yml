name: Build LetRecovery

on:
  workflow_dispatch:  # 允许手动触发

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: 
          - name: "正常系统端"
            path: "正常系统端"
          - name: "PE端"
            path: "PE端"
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装 Rust 工具链
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: 缓存 Cargo 依赖
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: 构建 ${{ matrix.target.name }}
      run: |
        cd "${{ matrix.target.path }}"
        cargo build --release --verbose
        
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.target.name }}-binary
        path: ${{ matrix.target.path }}/target/release/*
        if-no-files-found: error
        retention-days: 7

  release-build:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: 下载所有构建产物
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: '*-binary'
        merge-multiple: true
        
    - name: 列出构建文件
      run: |
        echo "构建完成的文件:"
        find artifacts -type f -name "*" 2>/dev/null || echo "未找到文件"
        
    - name: 准备发布包
      run: |
        # 创建发布目录
        mkdir -p release
        
        # 查找所有可执行文件
        if find artifacts -type f -executable 2>/dev/null | grep -q .; then
          find artifacts -type f -executable -exec cp {} release/ \;
        else
          # 如果没有可执行文件标记，复制所有文件
          find artifacts -type f -exec cp {} release/ 2>/dev/null || true
        fi
        
        # 添加可执行权限（Linux环境）
        chmod +x release/* 2>/dev/null || true
        
        echo "发布包内容:"
        ls -la release/ 2>/dev/null || echo "发布目录为空"
        
    - name: 上传发布包
      uses: actions/upload-artifact@v4
      with:
        name: letrecovery-release
        path: release/*
        if-no-files-found: warn
        retention-days: 30